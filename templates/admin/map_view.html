{% extends "admin/base_admin.html" %}
{% block title %}Reports Map â€” CivicConnect{% endblock %}
{% block page_title %}Reports Map{% endblock %}
{% block page_sub %}All submitted reports visualized by severity{% endblock %}
{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}
{% block content %}
<div style="display:grid;grid-template-columns:1fr 320px;gap:24px;align-items:start">
  <div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ—ºï¸ Live Reports Map</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-sm btn-outline" onclick="filterMarkers('all')">All</button>
          <button class="btn btn-sm" style="background:#dc2626;color:#fff" onclick="filterMarkers('Critical')">ğŸ”´ Critical</button>
          <button class="btn btn-sm" style="background:#ea580c;color:#fff" onclick="filterMarkers('High')">ğŸŸ  High</button>
          <button class="btn btn-sm" style="background:#ca8a04;color:#fff" onclick="filterMarkers('Medium')">ğŸŸ¡ Medium</button>
          <button class="btn btn-sm" style="background:#16a34a;color:#fff" onclick="filterMarkers('Low')">ğŸŸ¢ Low</button>
        </div>
      </div>
      <div class="card-body" style="padding:0"><div id="reportMap"></div></div>
    </div>
    <div class="card mt-4">
      <div class="card-body" style="padding:14px 22px">
        <div class="map-legend">
          <span class="text-sm fw-700" style="color:#64748b">SEVERITY:</span>
          <div class="legend-item"><div class="legend-dot dot-critical"></div> Critical</div>
          <div class="legend-item"><div class="legend-dot dot-high"></div> High</div>
          <div class="legend-item"><div class="legend-dot dot-medium"></div> Medium</div>
          <div class="legend-item"><div class="legend-dot dot-low"></div> Low</div>
        </div>
        <p class="text-sm text-muted" style="margin-top:8px">Click any marker to view details. Use filters to focus on priority levels.</p>
      </div>
    </div>
  </div>
  <div>
    <div class="card" style="position:sticky;top:80px;max-height:calc(100vh - 120px);overflow-y:auto">
      <div class="card-header"><div class="card-title">ğŸ“‹ Reports List</div><span class="text-sm text-muted">{{ reports|length }} shown</span></div>
      {% for r in reports %}
      <div onclick="flyToReport({{ r['latitude'] }},{{ r['longitude'] }})" style="padding:12px 16px;border-bottom:1px solid #f1f5f9;cursor:pointer;transition:background .2s" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background=''">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
          <div style="flex:1">
            <div style="font-size:.75rem;color:#94a3b8;font-family:monospace">{{ r['report_id'] }}</div>
            <div style="font-weight:600;font-size:.88rem;margin:2px 0">{{ r['title'] }}</div>
            <div style="font-size:.78rem;color:#64748b">{{ r['category'] }}</div>
          </div>
          <div>{% set sev=r['severity'] %}<span class="badge badge-{{ sev.lower() }}" style="font-size:.72rem">{% if sev=='Critical' %}ğŸ”´{% elif sev=='High' %}ğŸŸ {% elif sev=='Medium' %}ğŸŸ¡{% else %}ğŸŸ¢{% endif %} {{ sev }}</span></div>
        </div>
      </div>
      {% else %}
      <div style="text-align:center;padding:32px;color:#94a3b8"><p class="text-sm">No geotagged reports yet</p></div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const reports={{ reports_json|safe }};
const colors={Critical:'#dc2626',High:'#ea580c',Medium:'#ca8a04',Low:'#16a34a'};
let allMarkers=[],map;
window.addEventListener('load',function(){
  map=L.map('reportMap').setView([40.7128,-74.0060],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
  reports.forEach(r=>{
    if(!r.latitude||!r.longitude)return;
    const color=colors[r.severity]||'#64748b';
    const icon=L.divIcon({html:`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,.9);box-shadow:0 2px 10px rgba(0,0,0,.4)"></div>`,className:'',iconSize:[18,18],iconAnchor:[9,9]});
    const m=L.marker([r.latitude,r.longitude],{icon}).addTo(map).bindPopup(`<div style="min-width:200px;font-family:Inter,sans-serif"><div style="font-weight:800;font-size:.95rem;margin-bottom:6px">${r.title}</div><div style="font-size:.82rem;color:#64748b;margin-bottom:8px">${r.category}</div><div style="display:flex;gap:6px;flex-wrap:wrap"><span style="background:${color};color:#fff;padding:2px 10px;border-radius:99px;font-size:.75rem;font-weight:700">${r.severity}</span><span style="background:#f1f5f9;color:#475569;padding:2px 10px;border-radius:99px;font-size:.75rem">${r.status}</span></div>${r.location_address?`<div style="font-size:.8rem;color:#94a3b8;margin-top:6px">ğŸ“ ${r.location_address}</div>`:''}<div style="font-size:.78rem;color:#94a3b8;margin-top:6px;font-family:monospace">${r.report_id}</div></div>`,{maxWidth:280});
    m.severity=r.severity;allMarkers.push(m);
  });
});
function filterMarkers(sev){allMarkers.forEach(m=>{if(sev==='all'||m.severity===sev){if(!map.hasLayer(m))map.addLayer(m);}else{if(map.hasLayer(m))map.removeLayer(m);}});}
function flyToReport(lat,lng){map.flyTo([lat,lng],15,{animate:true,duration:1});allMarkers.forEach(m=>{if(Math.abs(m.getLatLng().lat-lat)<0.0001)m.openPopup();});}
</script>
{% endblock %}